stages:
  - Build_512K
  - Build_2M
  - cppcheck
  - tests
  - deploy

variables:
    GIT_CLEAN_FLAGS: -ffdx -e boot/cypress/libs -e venv
    GIT_SUBMODULE_STRATEGY: recursive

    CY_BOOTLOADER_MAJOR: 1
    CY_BOOTLOADER_MINOR: 1
    CY_BOOTLOADER_REV: 0
    CY_BOOTLOADER_BUILD: $CI_PIPELINE_IID
    CY_BOOTLOADER_TESTS_CONFIG: Debug
    
    CY_SECURETOOLS_BRANCH: ci-test
    PYOCD_BRANCH: ww05-sync-0.24.1
    
##############################################################################
# Build 
#


.build_512K:
  stage: Build_512K
  dependencies: []
  artifacts:
    expire_in: 4 weeks
    paths:
      - deploy
      - develop

.build_2M:
  stage: Build_2M
  dependencies: []
  artifacts:
    expire_in: 4 weeks
    paths:
      - deploy
      - develop


.mac_512K_Bootloader:
  extends: .build_512K
  tags:
    - FWS_MAC_BUILD
  script:
    # Build Release
    - >
      ./ci/build/build.sh
      APP_NAME=CypressBootloader
      PLATFORM=PSOC_064_512K
      BUILDCFG=Release
      MAKEINFO=0
      POST_BUILD=0
    # Build Debug
    - >
      ./ci/build/build.sh
      APP_NAME=CypressBootloader
      PLATFORM=PSOC_064_512K
      BUILDCFG=Debug
      MAKEINFO=0
      POST_BUILD=0


.mac_512K_BlinkyApp:
  extends: .build_512K
  tags:
    - FWS_MAC_BUILD
  script:
    # BOOT
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      PLATFORM=PSOC_064_512K
      MULTI_IMAGE=0
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Release
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      PLATFORM=PSOC_064_512K
      MULTI_IMAGE=0
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Debug
    # UPGRADE
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      PLATFORM=PSOC_064_512K
      MULTI_IMAGE=0
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Release
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      PLATFORM=PSOC_064_512K
      MULTI_IMAGE=0
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Debug        


.mac_512K_Multi_BlinkyApp:
  extends: .build_512K
  tags:
    - FWS_MAC_BUILD
  script:
    # BOOT
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      APP_SUFX=Multi
      PLATFORM=PSOC_064_512K
      MULTI_IMAGE=1
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Release
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      APP_SUFX=Multi
      PLATFORM=PSOC_064_512K
      MULTI_IMAGE=1
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Debug
    # UPGRADE
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      APP_SUFX=Multi
      PLATFORM=PSOC_064_512K
      MULTI_IMAGE=1
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Release
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      APP_SUFX=Multi
      PLATFORM=PSOC_064_512K
      MULTI_IMAGE=1
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Debug       
      
      
.mac_512K_SecureBlinkyApp:
  extends: .build_512K
  tags:
    - FWS_MAC_BUILD
  script:
    # BOOT
    - >
      ci/build/build.sh
      APP_NAME=SecureBlinkyApp
      PLATFORM=PSOC_064_512K
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Release
    - >
      ci/build/build.sh
      APP_NAME=SecureBlinkyApp
      PLATFORM=PSOC_064_512K
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Debug
    # UPGRADE
    - >
      ci/build/build.sh
      APP_NAME=SecureBlinkyApp
      PLATFORM=PSOC_064_512K
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Release
    - >
      ci/build/build.sh
      APP_NAME=SecureBlinkyApp
      PLATFORM=PSOC_064_512K
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Debug

.win_512K_Bootloader:
  extends: .build_512K
  tags:
    - FWS_WIN_BUILD
  script:
    - $env:Path="c:\cygwin64;c:\cygwin64\bin;$env:Path"
    # Build Release
    - >
      & "bash" "./ci/build/build.sh"
      APP_NAME=CypressBootloader
      PLATFORM=PSOC_064_512K
      BUILDCFG=Release
      MAKEINFO=0
      POST_BUILD=0      
    # Build Debug
    - >
      & "bash" "./ci/build/build.sh"
      APP_NAME=CypressBootloader
      PLATFORM=PSOC_064_512K
      BUILDCFG=Debug
      MAKEINFO=0
      POST_BUILD=0      

.win_512K_BlinkyApp:
  extends: .build_512K
  tags:
    - FWS_WIN_BUILD
  script:
    - $env:Path="c:\cygwin64;c:\cygwin64\bin;$env:Path"
    # BOOT
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      PLATFORM=PSOC_064_512K
      MULTI_IMAGE=0
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Release
    - >
      & "bash" "./ci/build/build.sh"
      APP_NAME=BlinkyApp
      PLATFORM=PSOC_064_512K
      MULTI_IMAGE=0
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Debug
    # UPGRADE
    - >
      & "bash" "./ci/build/build.sh"
      APP_NAME=BlinkyApp
      PLATFORM=PSOC_064_512K
      MULTI_IMAGE=0
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Release
    - >
      & "bash" "./ci/build/build.sh"
      APP_NAME=BlinkyApp
      PLATFORM=PSOC_064_512K
      MULTI_IMAGE=0
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Debug        


.win_512K_Multi_BlinkyApp:
  extends: .build_512K
  tags:
    - FWS_WIN_BUILD
  script:
    - $env:Path="c:\cygwin64;c:\cygwin64\bin;$env:Path"
    # BOOT
    - >
      & "bash" "./ci/build/build.sh"
      APP_NAME=BlinkyApp
      APP_SUFX=Multi
      PLATFORM=PSOC_064_512K
      MULTI_IMAGE=1
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Release
    - >
      & "bash" "./ci/build/build.sh"
      APP_NAME=BlinkyApp
      APP_SUFX=Multi
      PLATFORM=PSOC_064_512K
      MULTI_IMAGE=1
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Debug
    # UPGRADE
    - >
      & "bash" "./ci/build/build.sh"
      APP_NAME=BlinkyApp
      APP_SUFX=Multi
      PLATFORM=PSOC_064_512K
      MULTI_IMAGE=1
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Release
    - >
      & "bash" "./ci/build/build.sh"
      APP_NAME=BlinkyApp
      APP_SUFX=Multi
      PLATFORM=PSOC_064_512K
      MULTI_IMAGE=1
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Debug       
      
      
.win_512K_SecureBlinkyApp:
  extends: .build_512K
  tags:
    - FWS_WIN_BUILD
  script:
    - $env:Path="c:\cygwin64;c:\cygwin64\bin;$env:Path"
    # BOOT
    - >
      & "bash" "./ci/build/build.sh"
      APP_NAME=SecureBlinkyApp
      PLATFORM=PSOC_064_512K
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Release
    - >
      & "bash" "./ci/build/build.sh"
      APP_NAME=SecureBlinkyApp
      PLATFORM=PSOC_064_512K
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Debug
    # UPGRADE
    - >
      & "bash" "./ci/build/build.sh"
      APP_NAME=SecureBlinkyApp
      PLATFORM=PSOC_064_512K
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Release
    - >
      & "bash" "./ci/build/build.sh"
      APP_NAME=SecureBlinkyApp
      PLATFORM=PSOC_064_512K
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Debug      

.lin_512K_Bootloader:
  extends: .build_512K
  tags:
    - FWS_LIN_BUILD
  script:
    # Build Release
    - >
      ./ci/build/build.sh
      APP_NAME=CypressBootloader
      PLATFORM=PSOC_064_512K
      BUILDCFG=Release
      MAKEINFO=0
      POST_BUILD=0
    # Build Debug
    - >
      ./ci/build/build.sh
      APP_NAME=CypressBootloader
      PLATFORM=PSOC_064_512K
      BUILDCFG=Debug
      MAKEINFO=0
      POST_BUILD=0


.lin_512K_BlinkyApp:
  extends: .build_512K
  tags:
    - FWS_LIN_BUILD
  script:
    # BOOT
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      PLATFORM=PSOC_064_512K
      MULTI_IMAGE=0
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Release
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      PLATFORM=PSOC_064_512K
      MULTI_IMAGE=0
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Debug
    # UPGRADE
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      PLATFORM=PSOC_064_512K
      MULTI_IMAGE=0
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Release
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      PLATFORM=PSOC_064_512K
      MULTI_IMAGE=0
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Debug        


.lin_512K_Multi_BlinkyApp:
  extends: .build_512K
  tags:
    - FWS_LIN_BUILD
  script:
    # BOOT
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      APP_SUFX=Multi
      PLATFORM=PSOC_064_512K
      MULTI_IMAGE=1
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Release
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      APP_SUFX=Multi
      PLATFORM=PSOC_064_512K
      MULTI_IMAGE=1
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Debug
    # UPGRADE
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      APP_SUFX=Multi
      PLATFORM=PSOC_064_512K
      MULTI_IMAGE=1
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Release
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      APP_SUFX=Multi
      PLATFORM=PSOC_064_512K
      MULTI_IMAGE=1
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Debug       
      
      
.lin_512K_SecureBlinkyApp:
  extends: .build_512K
  tags:
    - FWS_LIN_BUILD
  script:
    # BOOT
    - >
      ci/build/build.sh
      APP_NAME=SecureBlinkyApp
      PLATFORM=PSOC_064_512K
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Release
    - >
      ci/build/build.sh
      APP_NAME=SecureBlinkyApp
      PLATFORM=PSOC_064_512K
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Debug
    # UPGRADE
    - >
      ci/build/build.sh
      APP_NAME=SecureBlinkyApp
      PLATFORM=PSOC_064_512K
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Release
    - >
      ci/build/build.sh
      APP_NAME=SecureBlinkyApp
      PLATFORM=PSOC_064_512K
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Debug      


mac_2M_Bootloader:
  extends: .build_2M
  tags:
    - FWS_MAC_BUILD
  script:
    # Build Release
    - >
      ./ci/build/build.sh
      APP_NAME=CypressBootloader
      PLATFORM=PSOC_064_2M
      BUILDCFG=Release
      MAKEINFO=0
      POST_BUILD=0
    # Build Debug
    - >
      ./ci/build/build.sh
      APP_NAME=CypressBootloader
      PLATFORM=PSOC_064_2M
      BUILDCFG=Debug
      MAKEINFO=0
      POST_BUILD=0


mac_2M_BlinkyApp:
  extends: .build_2M
  tags:
    - FWS_MAC_BUILD
  script:
    # BOOT
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      PLATFORM=PSOC_064_2M
      MULTI_IMAGE=0
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Release
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      PLATFORM=PSOC_064_2M
      MULTI_IMAGE=0
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Debug
    # UPGRADE
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      PLATFORM=PSOC_064_2M
      MULTI_IMAGE=0
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Release
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      PLATFORM=PSOC_064_2M
      MULTI_IMAGE=0
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Debug        


mac_2M_Multi_BlinkyApp:
  extends: .build_2M
  tags:
    - FWS_MAC_BUILD 
  script:
    # BOOT
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      APP_SUFX=Multi
      PLATFORM=PSOC_064_2M
      MULTI_IMAGE=1
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Release
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      APP_SUFX=Multi
      PLATFORM=PSOC_064_2M
      MULTI_IMAGE=1
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Debug
    # UPGRADE
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      APP_SUFX=Multi
      PLATFORM=PSOC_064_2M
      MULTI_IMAGE=1
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Release
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      APP_SUFX=Multi
      PLATFORM=PSOC_064_2M
      MULTI_IMAGE=1
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Debug       
      
      
mac_2M_SecureBlinkyApp:
  extends: .build_2M
  tags:
    - FWS_MAC_BUILD
  script:
    # BOOT
    - >
      ci/build/build.sh
      APP_NAME=SecureBlinkyApp
      PLATFORM=PSOC_064_2M
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Release
    - >
      ci/build/build.sh
      APP_NAME=SecureBlinkyApp
      PLATFORM=PSOC_064_2M
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Debug
    # UPGRADE
    - >
      ci/build/build.sh
      APP_NAME=SecureBlinkyApp
      PLATFORM=PSOC_064_2M
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Release
    - >
      ci/build/build.sh
      APP_NAME=SecureBlinkyApp
      PLATFORM=PSOC_064_2M
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Debug      



win_2M_Bootloader:
  extends: .build_2M
  tags:
    - FWS_WIN_BUILD
  script:
    - $env:Path="c:\cygwin64;c:\cygwin64\bin;$env:Path"
    # Build Release
    - >
      & "bash" "./ci/build/build.sh"
      APP_NAME=CypressBootloader
      PLATFORM=PSOC_064_2M
      BUILDCFG=Release
      MAKEINFO=0
      POST_BUILD=0      
    # Build Debug
    - >
      & "bash" "./ci/build/build.sh"
      APP_NAME=CypressBootloader
      PLATFORM=PSOC_064_2M
      BUILDCFG=Debug
      MAKEINFO=0
      POST_BUILD=0      

win_2M_BlinkyApp:
  extends: .build_2M
  tags:
    - FWS_WIN_BUILD
  script:
    - $env:Path="c:\cygwin64;c:\cygwin64\bin;$env:Path"
    # BOOT
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      PLATFORM=PSOC_064_2M
      MULTI_IMAGE=0
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Release
    - >
      & "bash" "./ci/build/build.sh"
      APP_NAME=BlinkyApp
      PLATFORM=PSOC_064_2M
      MULTI_IMAGE=0
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Debug
    # UPGRADE
    - >
      & "bash" "./ci/build/build.sh"
      APP_NAME=BlinkyApp
      PLATFORM=PSOC_064_2M
      MULTI_IMAGE=0
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Release
    - >
      & "bash" "./ci/build/build.sh"
      APP_NAME=BlinkyApp
      PLATFORM=PSOC_064_2M
      MULTI_IMAGE=0
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Debug        


win_2M_Multi_BlinkyApp:
  extends: .build_2M
  tags:
    - FWS_WIN_BUILD
  script:
    - $env:Path="c:\cygwin64;c:\cygwin64\bin;$env:Path"
    # BOOT
    - >
      & "bash" "./ci/build/build.sh"
      APP_NAME=BlinkyApp
      APP_SUFX=Multi
      PLATFORM=PSOC_064_2M
      MULTI_IMAGE=1
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Release
    - >
      & "bash" "./ci/build/build.sh"
      APP_NAME=BlinkyApp
      APP_SUFX=Multi
      PLATFORM=PSOC_064_2M
      MULTI_IMAGE=1
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Debug
    # UPGRADE
    - >
      & "bash" "./ci/build/build.sh"
      APP_NAME=BlinkyApp
      APP_SUFX=Multi
      PLATFORM=PSOC_064_2M
      MULTI_IMAGE=1
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Release
    - >
      & "bash" "./ci/build/build.sh"
      APP_NAME=BlinkyApp
      APP_SUFX=Multi
      PLATFORM=PSOC_064_2M
      MULTI_IMAGE=1
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Debug       
      
      
win_2M_SecureBlinkyApp:
  extends: .build_2M
  tags:
    - FWS_WIN_BUILD
  script:
    - $env:Path="c:\cygwin64;c:\cygwin64\bin;$env:Path"
    # BOOT
    - >
      & "bash" "./ci/build/build.sh"
      APP_NAME=SecureBlinkyApp
      PLATFORM=PSOC_064_2M
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Release
    - >
      & "bash" "./ci/build/build.sh"
      APP_NAME=SecureBlinkyApp
      PLATFORM=PSOC_064_2M
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Debug
    # UPGRADE
    - >
      & "bash" "./ci/build/build.sh"
      APP_NAME=SecureBlinkyApp
      PLATFORM=PSOC_064_2M
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Release
    - >
      & "bash" "./ci/build/build.sh"
      APP_NAME=SecureBlinkyApp
      PLATFORM=PSOC_064_2M
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Debug      

lin_2M_Bootloader:
  extends: .build_2M
  tags:
    - FWS_LIN_BUILD
  script:
    # Build Release
    - >
      ./ci/build/build.sh
      APP_NAME=CypressBootloader
      PLATFORM=PSOC_064_2M
      BUILDCFG=Release
      MAKEINFO=0
      POST_BUILD=0
    # Build Debug
    - >
      ./ci/build/build.sh
      APP_NAME=CypressBootloader
      PLATFORM=PSOC_064_2M
      BUILDCFG=Debug
      MAKEINFO=0
      POST_BUILD=0


lin_2M_BlinkyApp:
  extends: .build_2M
  tags:
    - FWS_LIN_BUILD
  script:
    # BOOT
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      PLATFORM=PSOC_064_2M
      MULTI_IMAGE=0
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Release
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      PLATFORM=PSOC_064_2M
      MULTI_IMAGE=0
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Debug
    # UPGRADE
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      PLATFORM=PSOC_064_2M
      MULTI_IMAGE=0
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Release
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      PLATFORM=PSOC_064_2M
      MULTI_IMAGE=0
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Debug        


lin_2M_Multi_BlinkyApp:
  extends: .build_2M
  tags:
    - FWS_LIN_BUILD
  script:
    # BOOT
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      APP_SUFX=Multi
      PLATFORM=PSOC_064_2M
      MULTI_IMAGE=1
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Release
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      APP_SUFX=Multi
      PLATFORM=PSOC_064_2M
      MULTI_IMAGE=1
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Debug
    # UPGRADE
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      APP_SUFX=Multi
      PLATFORM=PSOC_064_2M
      MULTI_IMAGE=1
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Release
    - >
      ci/build/build.sh
      APP_NAME=BlinkyApp
      APP_SUFX=Multi
      PLATFORM=PSOC_064_2M
      MULTI_IMAGE=1
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Debug       
      
      
lin_2M_SecureBlinkyApp:
  extends: .build_2M
  tags:
    - FWS_LIN_BUILD
  script:
    # BOOT
    - >
      ci/build/build.sh
      APP_NAME=SecureBlinkyApp
      PLATFORM=PSOC_064_2M
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Release
    - >
      ci/build/build.sh
      APP_NAME=SecureBlinkyApp
      PLATFORM=PSOC_064_2M
      MAKEINFO=0
      IMG_TYPE=BOOT
      BUILDCFG=Debug
    # UPGRADE
    - >
      ci/build/build.sh
      APP_NAME=SecureBlinkyApp
      PLATFORM=PSOC_064_2M
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Release
    - >
      ci/build/build.sh
      APP_NAME=SecureBlinkyApp
      PLATFORM=PSOC_064_2M
      MAKEINFO=0
      IMG_TYPE=UPGRADE
      BUILDCFG=Debug      



##############################################################################
# Run Test 
#


#######################################################################################################################################################
##################------------------------------------------------- TESTS 512K -------------------------------------------#############################
#######################################################################################################################################################


.mac_test_512K:
  stage: tests
  tags:
    - MBED_TEST_MAC1014
  cache: {}
  dependencies:
    - mac_512K_Bootloader
    - mac_512K_Multi_BlinkyApp
    - mac_512K_SecureBlinkyApp
    - mac_512K_BlinkyApp
  script:
    - export https_proxy=http://proxy.ua.cypress.com:8080
    - python3 --version
    - virtualenv venv
    - source venv/bin/activate
    - python3 -m pip install pyserial
    - python3 -m pip install --upgrade --force-reinstall git+http://git-ore.aus.cypress.com/repo/cysecuretools.git@${CY_SECURETOOLS_BRANCH}
    - python3 -m pip install --upgrade --force-reinstall git+http://git-ore.aus.cypress.com/repo/pyocd.git@SECUREBOOT_MCU_BETA4_RC1
    - pwd
    - rm -rf ./venv/lib/python3.7/site-packages/cysecuretools/targets/cyb06xx5/prebuilt/CyBootloader_Release
    - rm ./venv/lib/python3.7/site-packages/cysecuretools/targets/cyb06xx5/prebuilt/CyBootloader_WithLogs/CypressBootloader_CM0p.jwt
    - rm ./venv/lib/python3.7/site-packages/cysecuretools/targets/cyb06xx5/prebuilt/CyBootloader_WithLogs/CypressBootloader_CM0p.hex
    - cp -r ./develop/PSOC_064_512K/CypressBootloader/${CY_BOOTLOADER_TESTS_CONFIG}/*.hex ./venv/lib/python3.7/site-packages/cysecuretools/targets/cyb06xx5/prebuilt/CyBootloader_WithLogs/
    - cp -r ./develop/PSOC_064_512K/CypressBootloader/${CY_BOOTLOADER_TESTS_CONFIG}/*.jwt ./venv/lib/python3.7/site-packages/cysecuretools/targets/cyb06xx5/prebuilt/CyBootloader_WithLogs/

    - echo "[INFO] Start tests"

    - '[ -d tests ] && echo "[INFO] Directory tests exists." || echo "[INFO] Directory tests does not exists." && git clone http://git-ore.aus.cypress.com/repo/cy_mcuboot_project/cy_mcuboot.git tests && cd tests && git checkout tests_kosx_temp && git branch && cd .. '
    - cd tests
    - mbedls -j > mbedls_data.json
    - pwd

    - echo "[INFO] Test provisioning using single stage policy (CM4), CyBootloader WithLogs"
    - python3 -m unittest test_provisioning.TestProvisioning.test_provision_512k_release_single_image

    - cd ..
    - rm -rf tests

    - '[ -d tests ] && echo "[INFO] Directory tests exists." || echo "[INFO] Directory tests does not exists." && git clone http://git-ore.aus.cypress.com/repo/cy_mcuboot_project/cy_mcuboot.git tests && cd tests && git checkout tests_kosx_temp && git branch && cd .. '
    - cd tests
    - mbedls -j > mbedls_data.json
    - pwd

    - echo "[INFO] Test provisioning multi image, CyBootloader WithLogs"
    - python3 -m unittest test_provisioning.TestProvisioning.test_provision_512k_release_muilti_image

    - cd ..
    - rm -rf tests

    - deactivate

  artifacts:
    expire_in: 4 weeks
    paths:
      - deploy


#######################################################################################################################################################
##################------------------------------------------------- TESTS 2M ---------------------------------------------#############################
#######################################################################################################################################################

.mac_test_2M:
  stage: tests
  tags:
    - MBED_TEST_MAC1014
  dependencies:
    - mac_2M_Bootloader
    - mac_2M_Multi_BlinkyApp
    - mac_2M_SecureBlinkyApp
    - mac_2M_BlinkyApp
  script:
    - export https_proxy=http://proxy.ua.cypress.com:8080
    - python3 --version
    - virtualenv venv
    - source venv/bin/activate
    - python3 -m pip install pyserial
    - python3 -m pip install --upgrade --force-reinstall git+http://git-ore.aus.cypress.com/repo/cysecuretools.git@${CY_SECURETOOLS_BRANCH}
    - python3 -m pip install --upgrade --force-reinstall git+http://git-ore.aus.cypress.com/repo/pyocd.git@SECUREBOOT_MCU_BETA4_RC1
    - pwd
    - rm -rf ./venv/lib/python3.7/site-packages/cysecuretools/targets/cy8ckit_064x0s2_4343w/prebuilt/CyBootloader_Release
    - rm ./venv/lib/python3.7/site-packages/cysecuretools/targets/cy8ckit_064x0s2_4343w/prebuilt/CyBootloader_WithLogs/CypressBootloader_CM0p.jwt
    - rm ./venv/lib/python3.7/site-packages/cysecuretools/targets/cy8ckit_064x0s2_4343w/prebuilt/CyBootloader_WithLogs/CypressBootloader_CM0p.hex
    - cp -r ./develop/PSOC_064_2M/CypressBootloader/${CY_BOOTLOADER_TESTS_CONFIG}/*.hex ./venv/lib/python3.7/site-packages/cysecuretools/targets/cy8ckit_064x0s2_4343w/prebuilt/CyBootloader_WithLogs/
    - cp -r ./develop/PSOC_064_2M/CypressBootloader/${CY_BOOTLOADER_TESTS_CONFIG}/*.jwt ./venv/lib/python3.7/site-packages/cysecuretools/targets/cy8ckit_064x0s2_4343w/prebuilt/CyBootloader_WithLogs/

    - echo "[INFO] Start tests"

    - '[ -d tests ] && echo "[INFO] Directory tests exists." || echo "[INFO] Directory tests does not exists." && git clone http://git-ore.aus.cypress.com/repo/cy_mcuboot_project/cy_mcuboot.git tests && cd tests && git checkout tests_kosx_temp && git branch && cd .. '
    - cd tests
    - mbedls -j > mbedls_data.json
    - pwd

    - echo "[INFO] Test provisioning using single stage policy (CM4), CyBootloader WithLogs"
    - python3 -m unittest test_provisioning.TestProvisioning.test_provision_2M_release_single_image

    - cd ..
    - rm -rf tests

    - '[ -d tests ] && echo "[INFO] Directory tests exists." || echo "[INFO] Directory tests does not exists." && git clone http://git-ore.aus.cypress.com/repo/cy_mcuboot_project/cy_mcuboot.git tests && cd tests && git checkout tests_kosx_temp && git branch && cd .. '
    - cd tests
    - mbedls -j > mbedls_data.json
    - pwd

    - echo "[INFO] Test provisioning multi image, CyBootloader WithLogs"
    - python3 -m unittest test_provisioning.TestProvisioning.test_provision_2M_release_muilti_image

    - cd ..
    - rm -rf tests

    - deactivate

  artifacts:
    expire_in: 4 weeks
    paths:
      - deploy



# static code analyzer with Cppcheck tool
win_cpp_check:
  stage: cppcheck
  variables:
    GIT_STRATEGY: none
    GIT_SUBMODULE_STRATEGY: none
  dependencies: []
  tags:
    - MBED_TEST
  script:
    - cd boot/cypress
    - make run_cppcheck
    - cd ../../
  when: always


.MCUboot_simulator:
  stage: sim
  tags:
    - FW_SECURITY_TEST_UBUNTU1804
  cache: {}
  script:
    - export https_proxy=http://proxy.ua.cypress.com:8080
    - python3 --version
    - pwd
    - git submodule deinit --all -f
    - git submodule update --init --recursive
    - cd sim
    - cargo test --verbose

##############################################################################
# Upload build artifacts to http://iot-webserver.aus.cypress.com/projects/iot_release/ASSETS/repo/mcuboot/
deploy_asset:
  stage: deploy
  variables:
    GIT_STRATEGY: none
    GIT_SUBMODULE_STRATEGY: none
  tags:
    - devops-assets
  only:
    - /^develop$/
    - /^cypress$/
    - /^integration/cy_bootloader$/
    - /^feature/kosx-artifacts-zip$/ # TO DO delete this after test-deploy
  script:
    - zip -rX deploy/cy_bootloader_artifacts_${CY_BOOTLOADER_MAJOR}.${CY_BOOTLOADER_MINOR}.${CY_BOOTLOADER_REV}.${CY_BOOTLOADER_BUILD}.zip deploy
    - git clone git@git-ore.aus.cypress.com:devops/devops_scripts.git
    - bash devops_scripts/job_deploy_to_assets.sh
